From: Matthias Schiffer <mschiffer@universe-factory.net>
Date: Sun, 7 Mar 2021 12:05:28 +0100
Subject: fastd: add L2TP variant

Signed-off-by: Matthias Schiffer <mschiffer@universe-factory.net>

diff --git a/net/fastd/Config.in b/net/fastd/Config.in
index 157d1e39931cc0163785212cb5eea7d8af4f46f2..3da5e1f183c5400cc38650efad39edf31c6f18d0 100644
--- a/net/fastd/Config.in
+++ b/net/fastd/Config.in
@@ -1,4 +1,4 @@
-if PACKAGE_fastd
+if PACKAGE_fastd || PACKAGE_fastd-l2tp
 
 menu "Configuration"
 
diff --git a/net/fastd/Makefile b/net/fastd/Makefile
index 12c9dbc73a9a57d9518cf243674a4104cbacab5b..a9280562cb139418b21ecf72cc2c31a5893c3380 100644
--- a/net/fastd/Makefile
+++ b/net/fastd/Makefile
@@ -17,8 +17,8 @@ PKG_SOURCE_PROTO:=git
 PKG_SOURCE_URL:=https://github.com/NeoRaider/fastd.git
 PKG_MIRROR_HASH:=cae8b5d76305617c7946a67e1d21136d53b60a7fea67d45258ff566e1b787a90
 
-PKG_LICENSE:=BSD-2-Clause
-PKG_LICENSE_FILES:=COPYRIGHT
+PKG_LICENSE:=BSD-2-Clause LGPL-2.1-or-later
+PKG_LICENSE_FILES:=COPYRIGHT src/dep/libmnl/COPYING
 
 PKG_CONFIG_DEPENDS:=\
 	CONFIG_FASTD_ENABLE_METHOD_CIPHER_TEST \
@@ -56,6 +56,14 @@ define Package/fastd
   TITLE:=Fast and Secure Tunneling Daemon
   URL:=https://github.com/NeoRaider/fastd/
   SUBMENU:=VPN
+  VARIANT:=default
+endef
+define Package/fastd-l2tp
+$(Package/fastd)
+  DEPENDS+=+kmod-l2tp +kmod-l2tp-eth
+  TITLE+=(L2TP kernel offloading)
+  VARIANT:=l2tp
+  PROVIDES:=fastd
 endef
 
 define Package/fastd/config
@@ -87,18 +95,31 @@ MESON_ARGS += \
 	-Dmethod_null_l2tp=$(call feature,ENABLE_METHOD_NULL_L2TP) \
 	-Dstatus_socket=$(call feature,WITH_STATUS_SOCKET) \
 	-Doffload_l2tp=disabled \
+	-Dlibmnl_builtin=true \
 	-Dsystemd=disabled \
 	-Duse_nacl=true \
 	-Db_lto=true \
 	-Dprefix=/usr
 
+ifeq ($(BUILD_VARIANT),l2tp)
+  MESON_ARGS += \
+	-Dmethod_null_l2tp=enabled \
+	-Doffload_l2tp=enabled
+endif
+
 define Package/fastd/description
- Fast and secure tunneling daemon, which is optimized on small code size and few dependencies
+Fast and secure tunneling daemon, which is optimized on small code size and few dependencies
+endef
+define Package/fastd-l2tp/description
+$(Package/fastd/description)
+
+This variant enables L2TP kernel offloadig support.
 endef
 
 define Package/fastd/conffiles
 /etc/config/fastd
 endef
+Package/fastd-l2tp/conffiles = $(Package/fastd/conffiles)
 
 define Package/fastd/install
 	$(INSTALL_DIR) $(1)/usr/bin
@@ -112,5 +133,7 @@ define Package/fastd/install
 	$(INSTALL_DIR) $(1)/lib/upgrade/keep.d
 	$(INSTALL_DATA) files/fastd.upgrade $(1)/lib/upgrade/keep.d/fastd
 endef
+Package/fastd-l2tp/install = $(Package/fastd/install)
 
 $(eval $(call BuildPackage,fastd))
+$(eval $(call BuildPackage,fastd-l2tp))
